#!/usr/bin/env ruby

$:.unshift(File.expand_path(File.join(File.dirname(__FILE__), "../lib")))

require "ostruct"
require "optparse"
require "engine"

options = OpenStruct.new

raise ArgumentError, "Missing repo GitHub slug" unless (github_slug = ARGV[0])

parser = OptionParser.new do |opts|
  opts.banner = "Usage: runner REPO_GITHUB_SLUG [options]"

  opts.on("--codeclimate-token CODECLIMATE_TOKEN", String, "Specify a valid CodeClimate API token") do |cc_token|
    options.cc_token = cc_token
  end

  opts.on("--branch BRANCH", String, "Specify branch name to check coverage issues (base branch by defautl)") do |cc_token|
    options.cc_token = cc_token
  end

  opts.on_tail("-h", "--help", "Display help message") do
    puts opts
    exit
  end
end

parser.parse!(ARGV)

if options[:cc_token].nil?
  raise OptionParser::MissingArgument, "Use `--help` (`-h`) to see usage details"
end

Engine.new(
  github_slug: github_slug,
  options: options,
).run
